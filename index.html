<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Quiz</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #4f46e5; }
        .btn-primary:disabled { background: #d1d5db; cursor: not-allowed; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 32px; }
        .input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; }
        .input:focus { outline: none; border-color: #6366f1; }
        .error { background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
        .loading { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 12px; border-radius: 8px; margin-bottom: 16px; }
        .option { padding: 16px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s; margin-bottom: 12px; }
        .option:hover { border-color: #6366f1; }
        .option.selected { border-color: #6366f1; background: #eef2ff; }
        .timer { font-size: 24px; font-weight: bold; color: #6366f1; }
        .timer.warning { color: #dc2626; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #6366f1; transition: width 0.3s; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 12px; text-align: center; }
        .stat-value { font-size: 48px; font-weight: bold; }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 12px; font-size: 14px; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-error { background: #fee2e2; color: #991b1b; }
        .hidden { display: none; }
        .spinner { border: 3px solid #f3f4f6; border-top: 3px solid #6366f1; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh;">
    <div id="app"></div>
    
    <script src="config.js"></script>
    <script src="storage.js"></script>
    <script>
        class QuizApp {
            constructor() {
                this.state = {
                    screen: 'start',
                    currentQuestion: 0,
                    timeLeft: QUIZ_CONFIG.timePerQuestion,
                    answers: {},
                    name: '',
                    email: '',
                    startTime: null,
                    error: '',
                    loading: false,
                    loadingMessage: ''
                };
                this.timer = null;
                this.render();
            }

            setState(newState) {
                this.state = { ...this.state, ...newState };
                this.render();
            }

            validateEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            async startQuiz() {
                const { name, email } = this.state;
                
                if (!name.trim()) {
                    this.setState({ error: 'Please enter your name' });
                    return;
                }
                if (!email.trim()) {
                    this.setState({ error: 'Please enter your email' });
                    return;
                }
                if (!this.validateEmail(email)) {
                    this.setState({ error: 'Please enter a valid email address' });
                    return;
                }

                this.setState({ loading: true, loadingMessage: 'Checking if you have already taken the quiz...' });

                const isDuplicate = await storage.checkDuplicate(email);
                
                if (isDuplicate) {
                    this.setState({ 
                        error: 'This email has already been used to take the quiz',
                        loading: false,
                        loadingMessage: ''
                    });
                    return;
                }

                this.setState({ 
                    screen: 'quiz', 
                    error: '',
                    loading: false,
                    loadingMessage: '',
                    startTime: Date.now()
                });
                this.startTimer();
            }

            startTimer() {
                this.timer = setInterval(() => {
                    if (this.state.timeLeft <= 1) {
                        this.nextQuestion();
                    } else {
                        this.setState({ timeLeft: this.state.timeLeft - 1 });
                    }
                }, 1000);
            }

            selectAnswer(index) {
                const { currentQuestion, answers } = this.state;
                const questionId = QUIZ_CONFIG.questions[currentQuestion].id;
                answers[questionId] = index;
                this.setState({ answers });
            }

            nextQuestion() {
                clearInterval(this.timer);
                
                if (this.state.currentQuestion < QUIZ_CONFIG.questions.length - 1) {
                    this.setState({
                        currentQuestion: this.state.currentQuestion + 1,
                        timeLeft: QUIZ_CONFIG.timePerQuestion
                    });
                    this.startTimer();
                } else {
                    this.finishQuiz();
                }
            }

            calculateResults() {
                let correct = 0;
                QUIZ_CONFIG.questions.forEach(q => {
                    if (this.state.answers[q.id] === q.correctAnswer) {
                        correct++;
                    }
                });
                const percentage = Math.round((correct / QUIZ_CONFIG.questions.length) * 100);
                return { correct, total: QUIZ_CONFIG.questions.length, percentage };
            }

            async finishQuiz() {
                clearInterval(this.timer);
                
                this.setState({ loading: true, loadingMessage: 'Saving your results...' });

                const results = this.calculateResults();
                const resultData = {
                    name: this.state.name,
                    email: this.state.email,
                    score: results.percentage,
                    correct: results.correct,
                    total: results.total,
                    timeTaken: Math.round((Date.now() - this.state.startTime) / 1000),
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    answers: this.state.answers
                };

                const saved = await storage.saveResult(resultData);

                if (saved) {
                    this.setState({ screen: 'results', loading: false, loadingMessage: '' });
                } else {
                    this.setState({ 
                        error: 'Failed to save results. Please try again.',
                        loading: false,
                        loadingMessage: ''
                    });
                }
            }

            render() {
                const app = document.getElementById('app');
                
                if (this.state.screen === 'start') {
                    app.innerHTML = this.renderStart();
                } else if (this.state.screen === 'quiz') {
                    app.innerHTML = this.renderQuiz();
                } else {
                    app.innerHTML = this.renderResults();
                }

                this.attachEvents();
            }

            renderStart() {
                return `
                    <div class="container" style="padding-top: 60px;">
                        <div class="card" style="max-width: 500px; margin: 0 auto;">
                            <div style="text-align: center; margin-bottom: 32px;">
                                <div style="width: 80px; height: 80px; background: #eef2ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
                                    <span style="font-size: 40px;">üèÜ</span>
                                </div>
                                <h1 style="font-size: 32px; color: #111827; margin-bottom: 8px;">${QUIZ_CONFIG.title}</h1>
                                <p style="color: #6b7280;">Test your knowledge with our quiz</p>
                            </div>

                            <div style="background: #eef2ff; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
                                <h3 style="color: #4338ca; margin-bottom: 12px; font-weight: 600;">Quiz Rules:</h3>
                                <ul style="color: #4338ca; font-size: 14px; line-height: 24px; list-style: none;">
                                    <li>‚Ä¢ ${QUIZ_CONFIG.questions.length} questions total</li>
                                    <li>‚Ä¢ ${QUIZ_CONFIG.timePerQuestion} seconds per question</li>
                                    <li>‚Ä¢ Auto-advance when time expires</li>
                                    <li>‚Ä¢ No going back to previous questions</li>
                                    <li>‚Ä¢ Passing score: ${QUIZ_CONFIG.passingScore}%</li>
                                    <li>‚Ä¢ You can only take this quiz once</li>
                                </ul>
                            </div>

                            ${this.state.loading ? `<div class="loading"><div class="spinner"></div>${this.state.loadingMessage}</div>` : ''}
                            ${this.state.error ? `<div class="error">${this.state.error}</div>` : ''}

                            <div style="margin-bottom: 16px;">
                                <input type="text" class="input" id="name" placeholder="Your Full Name *" value="${this.state.name}">
                            </div>
                            <div style="margin-bottom: 24px;">
                                <input type="email" class="input" id="email" placeholder="Your Email *" value="${this.state.email}">
                            </div>
                            <button class="btn btn-primary" style="width: 100%;" onclick="quiz.startQuiz()" ${this.state.loading ? 'disabled' : ''}>
                                ${this.state.loading ? 'Please wait...' : 'Start Quiz'}
                            </button>
                        </div>
                    </div>
                `;
            }

            renderQuiz() {
                const question = QUIZ_CONFIG.questions[this.state.currentQuestion];
                const progress = ((this.state.currentQuestion + 1) / QUIZ_CONFIG.questions.length) * 100;
                const selectedAnswer = this.state.answers[question.id];
                const isAnswered = selectedAnswer !== undefined;

                return `
                    <div class="container" style="padding-top: 40px;">
                        <div class="card">
                            ${this.state.loading ? `<div class="loading"><div class="spinner"></div>${this.state.loadingMessage}</div>` : ''}
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div style="color: #6b7280;">Question ${this.state.currentQuestion + 1} of ${QUIZ_CONFIG.questions.length}</div>
                                <div class="timer ${this.state.timeLeft <= 5 ? 'warning' : ''}">${this.state.timeLeft}s</div>
                            </div>
                            <div class="progress-bar" style="margin-bottom: 32px;">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            
                            <h2 style="font-size: 24px; color: #111827; margin-bottom: 24px;">${question.question}</h2>
                            
                            <div>
                                ${question.options.map((option, index) => `
                                    <div class="option ${selectedAnswer === index ? 'selected' : ''}" onclick="quiz.selectAnswer(${index})">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="width: 24px; height: 24px; border: 2px solid ${selectedAnswer === index ? '#6366f1' : '#d1d5db'}; border-radius: 50%; background: ${selectedAnswer === index ? '#6366f1' : 'white'}; display: flex; align-items: center; justify-content: center;">
                                                ${selectedAnswer === index ? '<div style="width: 12px; height: 12px; background: white; border-radius: 50%;"></div>' : ''}
                                            </div>
                                            <span style="color: #111827;">${option}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <button class="btn btn-primary" style="width: 100%; margin-top: 24px;" onclick="quiz.nextQuestion()" ${!isAnswered || this.state.loading ? 'disabled' : ''}>
                                ${this.state.currentQuestion < QUIZ_CONFIG.questions.length - 1 ? 'Next Question' : 'Finish Quiz'}
                            </button>
                        </div>
                    </div>
                `;
            }

            renderResults() {
                const results = this.calculateResults();
                const passed = results.percentage >= QUIZ_CONFIG.passingScore;

                return `
                    <div class="container" style="padding-top: 60px;">
                        <div class="card" style="max-width: 700px; margin: 0 auto;">
                            <div style="text-align: center; margin-bottom: 32px;">
                                <div style="font-size: 80px; margin-bottom: 16px;">${passed ? '‚úÖ' : '‚ùå'}</div>
                                <h1 style="font-size: 32px; color: #111827; margin-bottom: 8px;">${passed ? 'Congratulations!' : 'Quiz Complete'}</h1>
                                <p style="color: #6b7280;">${this.state.name}, here are your results</p>
                            </div>

                            <div class="stat-card" style="margin-bottom: 24px;">
                                <div class="stat-value">${results.percentage}%</div>
                                <div style="margin-top: 8px;">Final Score</div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                                <div style="background: #f3f4f6; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold; color: #16a34a;">${results.correct}</div>
                                    <div style="color: #6b7280; font-size: 14px;">Correct</div>
                                </div>
                                <div style="background: #f3f4f6; padding: 20px; border-radius: 12px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: bold; color: #dc2626;">${results.total - results.correct}</div>
                                    <div style="color: #6b7280; font-size: 14px;">Incorrect</div>
                                </div>
                            </div>

                            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280;">Total Questions</span>
                                <span style="font-weight: 600;">${results.total}</span>
                            </div>
                            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280;">Passing Score</span>
                                <span style="font-weight: 600;">${QUIZ_CONFIG.passingScore}%</span>
                            </div>
                            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 24px; display: flex; justify-content: space-between;">
                                <span style="color: #6b7280;">Status</span>
                                <span class="badge ${passed ? 'badge-success' : 'badge-error'}">${passed ? 'PASSED' : 'NOT PASSED'}</span>
                            </div>

                            <div style="background: #dcfce7; border: 1px solid #86efac; padding: 16px; border-radius: 8px; text-align: center;">
                                <p style="color: #166534; font-size: 14px;">‚úÖ Your results have been saved to the database!</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            attachEvents() {
                const nameInput = document.getElementById('name');
                const emailInput = document.getElementById('email');
                
                if (nameInput) {
                    nameInput.addEventListener('input', (e) => {
                        this.state.name = e.target.value;
                    });
                }
                
                if (emailInput) {
                    emailInput.addEventListener('input', (e) => {
                        this.state.email = e.target.value;
                    });
                }
            }
        }

        const quiz = new QuizApp();
    </script>
</body>
</html>
